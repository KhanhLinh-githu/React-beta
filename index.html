
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React - Photobooth by Kh√°nh Linh</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="./logo.png" />
    
    <style>
        :root {
            --bg-color: #f0f0f0;
            --primary: #111;
            --accent: #3b82f6;
            --danger: #ef4444;
        }

        body {
            font-family: 'Space Mono', monospace;
            background: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--primary);
        }

        h1, h2, h3 { margin: 0; text-transform: lowercase; }

        /* utilities */
        .hidden { display: none !important; }
        .btn {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            background: white;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: 0.2s;
            text-transform: lowercase;
        }
        .btn:hover { background: var(--primary); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-icon { border-radius: 50%; width: 40px; height: 40px; padding: 0; display: grid; place-items: center; }

        /* container ch√≠nh */
        .container {
            width: 95%;
            max-width: 1000px;
            background: white;
            margin: 20px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
            min-height: 80vh;
            position: relative;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

/* --- style cho logo (v·ªã tr√≠ c·ªë ƒë·ªãnh) --- */
    #logo-container {
        position: fixed; /* gi·ªØ logo c·ªë ƒë·ªãnh tr√™n m√†n h√¨nh */
        top: 20px; /* c√°ch l·ªÅ tr√™n 20px */
        left: 20px; /* c√°ch l·ªÅ tr√°i 20px */
        z-index: 100; /* ƒë·∫£m b·∫£o logo lu√¥n n·∫±m tr√™n c√°c th√†nh ph·∫ßn kh√°c */
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.7); /* n·ªÅn m·ªù ƒë·ªÉ logo n·ªïi b·∫≠t */
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #my-logo {
        height: 40px; /* ƒëi·ªÅu ch·ªânh chi·ªÅu cao c·ªßa logo */
        width: auto;
        display: block;
    }

        /* --- b∆∞·ªõc 1: ch·ªçn layout --- */
        #step-1 { text-align: center; padding-top: 50px; }
        .layout-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        .layout-card {
            border: 2px solid #ddd;
            padding: 20px;
            cursor: pointer;
            border-radius: 12px;
            transition: 0.2s;
        }
        .layout-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .mini-frame {
            background: #eee;
            margin: 0 auto 10px;
            border: 1px solid #999;
        }
        /* m√¥ ph·ªèng c√°c √¥ */
        .grid-3, .grid-4 { width: 40px; display: flex; flex-direction: column; gap: 2px; padding: 4px; }
        .grid-3 div { height: 30px; background: white; border: 1px solid #ccc; }
        .grid-4 div { height: 22px; background: white; border: 1px solid #ccc; }
        
        .grid-6 { width: 60px; display: grid; grid-template-columns: 1fr 1fr; gap: 2px; padding: 4px; }
        .grid-6 div { height: 25px; background: white; border: 1px solid #ccc; }

        /* --- b∆∞·ªõc 2: ch·ª•p ·∫£nh --- */
        #step-2 { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .camera-area {
            position: relative;
            width: 100%;
            max-width: 500px;
            border-radius: 12px;
            overflow: hidden;
            background: black;
        }
        video { width: 100%; display: block; transform: scaleX(-1); /* l·∫≠t g∆∞∆°ng */ }
        #capture-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: white;
            border: 4px solid var(--primary);
            position: absolute;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
        }
        #capture-btn:active { transform: translateX(-50%) scale(0.9); }

        /* v√πng preview ·∫£nh ƒë√£ ch·ª•p */
        .preview-strip-container {
            margin-top: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* --- style chung cho strip ·∫£nh (d√πng ·ªü c·∫£ b∆∞·ªõc 2 v√† 3) --- */
        .photo-strip {
            background: white; /* m√†u m·∫∑c ƒë·ªãnh */
            padding: 15px;
            display: grid;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: background 0.3s;
            width: fit-content;
        }
        
        /* dynamic classes for strip layout */
        .strip-layout-3, .strip-layout-4 {
            grid-template-columns: 1fr;
            width: 200px; /* chi·ªÅu r·ªông c·ªë ƒë·ªãnh cho strip d·ªçc */
        }
        .strip-layout-6 {
            grid-template-columns: 1fr 1fr;
            width: 320px; /* r·ªông h∆°n cho 2 c·ªôt */
        }

        /* √¥ ·∫£nh trong strip */
        .photo-slot {
            background: #eee;
            aspect-ratio: 4/3; /* t·ªâ l·ªá ·∫£nh */
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .photo-slot img {
            width: 100%; height: 100%; object-fit: cover;
            display: block;
        }
        .photo-slot .delete-btn {
            position: absolute;
            top: 5px; right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
        }

        /* --- b∆∞·ªõc 3: trang tr√≠ --- */
        #step-3 { display: flex; height: 100%; }
        .split-view { display: flex; width: 100%; gap: 30px; height: 600px; }
        
        .left-preview {
            flex: 1;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            overflow-y: auto;
        }

        .right-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 30px;
            justify-content: center;
        }

        .control-group h3 { margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .options-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .option-btn {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            min-width: 80px;
        }
        .option-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* m√†u s·∫Øc cho n√∫t frame */
        .color-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; }
        .color-btn.active { border-color: var(--accent); transform: scale(1.1); }

        /* css filters */
        .filter-bright img { filter: brightness(1.2); }
        .filter-bw img { filter: grayscale(100%); }
        .filter-none img { filter: none; }

        /* --- b∆∞·ªõc 4: download --- */
        #step-4 { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .success-icon { font-size: 60px; color: #10b981; margin-bottom: 20px; }
        
    </style>
</head>
<body>

    <div id="logo-container">
        <img id="my-logo" src="./logo.png" alt="logo">
    </div>
 

    <div class="container">
        <button id="back-btn" class="btn btn-icon back-btn hidden"><i class="fas fa-arrow-left"></i></button>

        <div id="step-1">
            <h1>Ch·ªçn ki·ªÉu khung h√¨nh</h1>
            <p>B·∫Øt ƒë·∫ßu ch·ª•p photobooth online n√†o b·∫°n ei</p>
            
            <div class="layout-options">
                <div class="layout-card" onclick="selectLayout(3)">
                    <div class="mini-frame grid-3"><div></div><div></div><div></div></div>
                    <span>3 √¥ d·ªçc</span>
                </div>
                <div class="layout-card" onclick="selectLayout(4)">
                    <div class="mini-frame grid-4"><div></div><div></div><div></div><div></div></div>
                    <span>4 √¥ d·ªçc</span>
                </div>
                <div class="layout-card" onclick="selectLayout(6)">
                    <div class="mini-frame grid-6"><div></div><div></div><div></div><div></div><div></div><div></div></div>
                    <span>6 √¥ (2 c·ªôt)</span>
                </div>
            </div>
        </div>

        <div id="step-2" class="hidden">
            <h2>H√£y c∆∞·ªùi th·∫≠t t∆∞∆°i n√†o üì∏</h2>
            
            <div class="camera-area">
                <video id="video" autoplay playsinline></video>
                <button id="capture-btn"></button>
            </div>

            <div class="preview-strip-container">
                <div id="capture-strip" class="photo-strip">
                    </div>
            </div>

            <button id="finish-capture-btn" class="btn" onclick="goToStep3()" disabled>ti·∫øp t·ª•c trang tr√≠ <i class="fas fa-arrow-right"></i></button>
        </div>

        <div id="step-3" class="hidden">
            <div class="split-view">
                <div class="left-preview">
                    <div id="final-strip" class="photo-strip">
                        </div>
                </div>

                <div class="right-controls">
                    <div class="control-group">
                        <h3>1. Ch·ªçn filter ·∫£nh</h3>
                        <div class="options-grid" id="filter-options">
                            <div class="option-btn" onclick="applyFilter('none', this)">g·ªëc</div>
                            <div class="option-btn" onclick="applyFilter('bright', this)">s√°ng ‚ú®</div>
                            <div class="option-btn" onclick="applyFilter('bw', this)">tr·∫Øng ƒëen üé¨</div>
                        </div>
                    </div>

                    <div class="control-group">
                        <h3>2. Ch·ªçn m√†u khung</h3>
                        <div class="options-grid" id="color-options">
                            <div class="color-btn" style="background: #A31D1D;" onclick="applyFrameColor('#A31D1D', this)"></div>
                            <div class="color-btn" style="background: #191919;" onclick="applyFrameColor('#191919', this)"></div>
                            <div class="color-btn" style="background: #191919;" onclick="applyFrameColor('#0D1164', this)"></div>
                            <div class="color-btn" style="background: #191919;" onclick="applyFrameColor('#1E5128', this)"></div>
                            <div class="color-btn" style="background: #FFFFFF; border: 1px solid #ccc;" onclick="applyFrameColor('#FFFFFF', this)"></div>
                        </div>
                    </div>

                    <button id="finish-edit-btn" class="btn" onclick="goToStep4()" disabled>xu·∫•t ·∫£nh pdf <i class="fas fa-magic"></i></button>
                </div>
            </div>
        </div>

        <div id="step-4" class="hidden">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2>xong r·ªìi n√®!</h2>
            <p>·∫¢nh c·ªßa b·∫°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ t·∫£i xu·ªëng.</p>
            <br>
            <button class="btn" onclick="downloadPDF()" style="background: var(--primary); color: white;">T·∫£i xu·ªëng pdf ngay <i class="fas fa-download"></i></button>
            <br><br>
            <button class="btn" onclick="location.reload()">L√†m c√°i n·ªØa kh√¥ng?</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // --- variables ---
        let currentStep = 1;
        let selectedLayout = 0; // 3, 4, or 6
        let photos = []; // m·∫£ng ch·ª©a base64 ·∫£nh
        let stream = null;
        
        let selectedFilter = null;
        let selectedFrameColor = null;

        // --- dom elements ---
        const steps = [1, 2, 3, 4].map(i => document.getElementById(`step-${i}`));
        const backBtn = document.getElementById('back-btn');
        const video = document.getElementById('video');
        const captureStrip = document.getElementById('capture-strip');
        const finalStrip = document.getElementById('final-strip');
        const finishCaptureBtn = document.getElementById('finish-capture-btn');
        const finishEditBtn = document.getElementById('finish-edit-btn');

        // --- navigation logic ---
        function showStep(stepNum) {
            steps.forEach((el, index) => {
                if (index + 1 === stepNum) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            
            // x·ª≠ l√Ω n√∫t back
            if (stepNum === 1) backBtn.classList.add('hidden');
            else backBtn.classList.remove('hidden');

            currentStep = stepNum;
        }

        backBtn.onclick = () => {
            if (currentStep === 2) {
                stopCamera();
                photos = []; // reset ·∫£nh n·∫øu quay l·∫°i ch·ªçn layout
                showStep(1);
            } else if (currentStep === 3) {
                // reset l·ª±a ch·ªçn ·ªü b∆∞·ªõc 3
                selectedFilter = null;
                selectedFrameColor = null;
                updateEditButtonState();
                // x√≥a class active c≈©
                document.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                
                // quay l·∫°i camera, gi·ªØ nguy√™n ·∫£nh c≈©
                initCamera();
                showStep(2);
            } else if (currentStep === 4) {
                showStep(3);
            }
        };

        // --- step 1 logic ---
        function selectLayout(num) {
            selectedLayout = num;
            photos = new Array(num).fill(null); // t·∫°o m·∫£ng r·ªóng c√≥ ƒë·ªô d√†i = num
            initCamera();
            renderCaptureGrid();
            showStep(2);
        }

        // --- step 2 logic: camera & capture ---
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
            } catch (err) {
                alert("Kh√¥ng t√¨m th·∫•y camera r·ªìi b·∫°n ∆°i :( Ki·ªÉm tra quy·ªÅn truy c·∫≠p nh√©.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function renderCaptureGrid() {
            captureStrip.className = `photo-strip strip-layout-${selectedLayout}`;
            captureStrip.innerHTML = '';

            photos.forEach((photo, index) => {
                const slot = document.createElement('div');
                slot.className = 'photo-slot';
                
                if (photo) {
                    // ƒë√£ c√≥ ·∫£nh
                    const img = document.createElement('img');
                    img.src = photo;
                    
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.innerHTML = '<i class="fas fa-times"></i>';
                    delBtn.onclick = () => deletePhoto(index);

                    slot.appendChild(img);
                    slot.appendChild(delBtn);
                } else {
                    // ch∆∞a c√≥ ·∫£nh
                    slot.innerText = index + 1;
                    slot.style.color = '#ccc';
                }
                captureStrip.appendChild(slot);
            });

            // check if full to enable next button
            const isFull = photos.every(p => p !== null);
            finishCaptureBtn.disabled = !isFull;
        }

        document.getElementById('capture-btn').onclick = () => {
            // t√¨m slot tr·ªëng ƒë·∫ßu ti√™n
            const emptyIndex = photos.indexOf(null);
            if (emptyIndex === -1) return; // ƒë√£ ƒë·∫ßy

            // ch·ª•p ·∫£nh t·ª´ video
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // l·∫≠t ·∫£nh cho gi·ªëng g∆∞∆°ng
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            photos[emptyIndex] = canvas.toDataURL('image/png');
            renderCaptureGrid();
        };

        function deletePhoto(index) {
            photos[index] = null;
            renderCaptureGrid();
        }

        function goToStep3() {
            stopCamera();
            renderFinalStrip();
            showStep(3);
        }

        // --- step 3 logic: editor ---
        function renderFinalStrip() {
            finalStrip.className = `photo-strip strip-layout-${selectedLayout}`;
            finalStrip.innerHTML = '';
            // reset style
            finalStrip.style.background = '#FFFFFF'; 

            photos.forEach(photo => {
                const slot = document.createElement('div');
                slot.className = 'photo-slot'; // m·∫∑c ƒë·ªãnh class
                
                const img = document.createElement('img');
                img.src = photo;
                slot.appendChild(img);
                finalStrip.appendChild(slot);
            });
        }

        function applyFilter(filterType, btnElement) {
            selectedFilter = filterType;
            
            // update UI buttons
            document.querySelectorAll('#filter-options .option-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // update visual strip
            const slots = finalStrip.querySelectorAll('.photo-slot');
            slots.forEach(slot => {
                slot.className = 'photo-slot'; // reset
                if (filterType === 'bright') slot.classList.add('filter-bright');
                if (filterType === 'bw') slot.classList.add('filter-bw');
                if (filterType === 'none') slot.classList.add('filter-none');
            });

            updateEditButtonState();
        }

        function applyFrameColor(colorCode, btnElement) {
            selectedFrameColor = colorCode;

            // update UI buttons
            document.querySelectorAll('#color-options .color-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // update visual strip
            finalStrip.style.background = colorCode;

            updateEditButtonState();
        }

        function updateEditButtonState() {
            // b·∫Øt bu·ªôc ch·ªçn c·∫£ 2 m·ªõi ƒë∆∞·ª£c ƒëi ti·∫øp
            if (selectedFilter && selectedFrameColor) {
                finishEditBtn.disabled = false;
            } else {
                finishEditBtn.disabled = true;
            }
        }

        function goToStep4() {
            showStep(4);
        }

        // --- step 4: download pdf ---
        window.jsPDF = window.jspdf.jsPDF;

        // --- S·ª¨A L·∫†I H√ÄM N√ÄY (C√ÅCH CLONE) ---
        async function downloadPDF() {
            const element = document.getElementById('final-strip');
            const btn = document.querySelector('#step-4 button'); 
            
            // 1. B√°o hi·ªáu ƒëang x·ª≠ l√Ω
            const originalText = btn.innerHTML;
            btn.innerHTML = 'ƒëang x·ª≠ l√Ω... <i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            // Bi·∫øn ch·ª©a b·∫£n sao
            let clone = null;

            try {
                // 2. T·∫†O B·∫¢N SAO (CLONE) c·ªßa d·∫£i ·∫£nh
                // Ch√∫ng ta copy y nguy√™n d·∫£i ·∫£nh ra m·ªôt c√°i m·ªõi
                clone = element.cloneNode(true);

                // 3. Thi·∫øt l·∫≠p style b·∫Øt bu·ªôc cho b·∫£n sao ƒë·ªÉ n√≥ lu√¥n hi·ªán
                // ƒê∆∞a n√≥ ra kh·ªèi m√†n h√¨nh (-10000px) nh∆∞ng v·∫´n ƒë·ªÉ ch·∫ø ƒë·ªô hi·ªÉn th·ªã
                clone.style.position = 'fixed';
                clone.style.left = '-10000px'; 
                clone.style.top = '0px';
                clone.style.zIndex = '-1';
                clone.style.display = 'grid'; // B·∫Øt bu·ªôc d√πng grid gi·ªëng CSS g·ªëc
                clone.style.visibility = 'visible'; // B·∫Øt bu·ªôc hi·ªán
                
                // Copy background m√†u hi·ªán t·∫°i c·ªßa element g·ªëc sang clone (ph√≤ng tr∆∞·ªùng h·ª£p background ƒë√®)
                clone.style.background = element.style.background || '#FFFFFF';

                // G·∫Øn b·∫£n sao v√†o th·∫≥ng body
                document.body.appendChild(clone);

                // 4. Ch·ªù 500ms ƒë·ªÉ tr√¨nh duy·ªát render xong h√¨nh ·∫£nh trong b·∫£n sao
                await new Promise(resolve => setTimeout(resolve, 500));

                // 5. Ch·ª•p ·∫£nh t·ª´ B·∫¢N SAO (clone) ch·ª© kh√¥ng ph·∫£i b·∫£n g·ªëc
                const canvas = await html2canvas(clone, {
                    scale: 3, // TƒÉng l√™n 3 ƒë·ªÉ ·∫£nh n√©t h∆°n
                    useCORS: true,
                    logging: false,
                    backgroundColor: null,
                    // Quan tr·ªçng: Ch·ªâ ƒë·ªãnh r√µ k√≠ch th∆∞·ªõc ch·ª•p b·∫±ng k√≠ch th∆∞·ªõc th·∫≠t c·ªßa clone
                    width: clone.offsetWidth,
                    height: clone.offsetHeight,
                    windowWidth: document.documentElement.offsetWidth,
                    windowHeight: document.documentElement.offsetHeight
                });

                // 6. T·∫°o PDF
                const imgData = canvas.toDataURL('image/png');

                // Ki·ªÉm tra k·ªπ l·∫°i d·ªØ li·ªáu ·∫£nh
                if (imgData === 'data:,' || canvas.width === 0 || canvas.height === 0) {
                    throw new Error("K√≠ch th∆∞·ªõc ·∫£nh b·∫±ng 0. Tr√¨nh duy·ªát ch∆∞a k·ªãp v·∫Ω.");
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;
                
                // T√≠nh to√°n t·ª∑ l·ªá ƒë·ªÉ cƒÉn gi·ªØa
                const finalWidth = 80; // ƒê·ªô r·ªông ·∫£nh trong PDF (mm)
                const finalHeight = (imgHeight * finalWidth) / imgWidth;
                const x = (pdfWidth - finalWidth) / 2;
                const y = 20;

                pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
                pdf.save(`Photobooth-React-${Date.now()}.pdf`);

            } catch (err) {
                console.error("Chi ti·∫øt l·ªói:", err);
                alert("L·ªói: " + err.message + "\nB·∫°n h√£y th·ª≠ l·∫°i l·∫ßn n·ªØa nh√©!");
            } finally {
                // 7. D·ªçn d·∫πp: X√≥a b·∫£n sao kh·ªèi trang web d√π th√†nh c√¥ng hay th·∫•t b·∫°i
                if (clone && document.body.contains(clone)) {
                    document.body.removeChild(clone);
                }
                
                // Tr·∫£ l·∫°i n√∫t b·∫•m
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>





